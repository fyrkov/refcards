### Load Balancers.

Features:
* single access point (DNS) to an app
* splits traffic between instances
* separates public and private traffic
* provides TLS termination
* do regular healthchecks of instances
* stickiness with cookies
* hi availability across zones

ELB is an AWS managed LB.

Health checks
App has to have an exposed healthcheck endpoint (`/health` or another route).\
If an instance does not respond with `200OK` on the healthcheck endpoint,
ELB will not send traffic to the instance.

Types of LBs:
* Classic Load Balancer (CLB). Deprecated, but still works.
* Application Load Balancer (ALB). Supports HTTP/S, WebSocket
* Network Load Balancer (NLB). Supports TCP, TLS, UDP
* Gateway Load Balancer (GLB). Operates at network layer, IP protocol.

#### CLB
App will get a fixed hostname like `xxx.region.elb.amazonaws.com`

#### ALB
Allows balancing to multiple apps across machines (target groups).\
Allows balancing to multiple apps on the same host (containers).\
Supports redirect, e.g. HTTPS -> HTTPS.

Routing can be based on URL, path, hostname, query string, headers, source IP.\
For that listener rules can be modified after creation in IF-THEN style.

ALB is good for Docker and ECS as it supports routing to dynamic ports in ECS.\
CLB would require one LB per app.

Target groups can group:
* EC2 instances
* ECS tasks
* Lambdas
* IP addresses (private, not public!)
* other ALB.


ALB can route to multiple TGs.\
Healthchecks are at the TG level.\
ALB require listener rules to define routing to TGs.\
A Listener rule can also respond with a fixed response instead of forwarding.

As for CLB ALB gets a fixed hostname like `xxx.region.elb.amazonaws.com`.

The app won't be able to see clients IP directly but it is forwarded in the `X-Forwarded-For` header.\
Also there will be `X-Forwarded-ports` and `X-Forwarded-Proto`.

ALB can be `internet-facing` or `internal`.

#### NLB
Supports TCP, TLS, UDP, i.e. OSI Layer 4.\
Has hi throughput and lo latency (~100ms) comparing to ALB (~400ms).

NLB has an assigned static IP instead of a hostname.

Use cases: hi perf TCP or UDP traffic.

TGs can group EC2, IP addresses, ALB (it is possible to chain NLB -> ALB).

~~Listener rules work only for traffic/port pair.~~  what about more complex listener rules??

:exclamation: NLB does not have attached SGs!\
Therefore EC2 SGs need to allow not by SG but by IP ranges (NLB is transparent for EC2s).\
Also blocking traffic at NLB level is not possible (unlike ALB), only NACL and EC2 SGs left.

NLB can target:
* Instance Id
* Private IP of the instance

Request Routing and IP Addresses:
* If you specify targets using an instance ID, traffic is routed to instances using the primary private IP address specified in the primary network interface for the instance.\
The load balancer rewrites the destination IP address from the data packet before forwarding it to the target instance.
* If you specify targets using IP addresses, you can route traffic to an instance using any private IP address from one or more network interfaces.\
This enables multiple applications on an instance to use the same port.\
Note that each network interface can have its security group.\
The load balancer rewrites the destination IP address before forwarding it to the target.

#### GLB (Gateway Load Balancer)
Required when for example all traffic needs to go through fleet of 3rd party network components like a firewall or DPI system etc.

Operates at layer 3 - IP packets.

Combines functions:
* transparent network gateway - single entry/exit for all traffic
* load balancing traffic to 3party components

Uses the GENEVE protocol on port 6081.

#### Sticky sessions (Session affinity)
CLB and ALB can route the same client to the same instance.\
Done with cookies: application custom or application generated by LB or duration-based generated by LB.

Stickiness is an attribute of TG.

#### Cross-zone load balancing
Balancing to instances in different AZs evenly.\
ALB - always enabled. No charges.\
NLB - can be enabled. Charges apply.\
CLB - disbled by default, no charges if enabled.

#### TLS
LBs use X.509 cert.\
A cert can be added to LB in listeners when an HTTPS is selected.\
Certs can be managed in ACM - AWS Certificate Manager.\
It is possible to add list of optional certs to support multiple domains.

How does one machine serve multiple websites?\
It is necessary to load multiple SSL certs.\
**SNI** - Server Name Indication is a new protocol that resolves this issue and allows exposing multiple\
HTTPS applications each with its own SSL certificate on the same listener.\
Read more here: https://aws.amazon.com/blogs/aws/new-application-load-balancer-sni/

Clients can use SNI to specify the hostname they want to reach.\
Works only for ALB, NLB. Does not work with CLB.

#### Connection Draining/Deregistration Delay
The time to complete in-flight requests if an instance is de-registered.\
LB then stops sending new requests and waits for existing in-flight requests to complete.\
By default is `300 seconds`, can be between `[0,3600] seconds`.

#### ASGs
LBs and Auto scaling groups work well together, i.e. when ASG scales out the app, LB registers new instances.\
For that ASG needs to be attached during creation to LB's TG.

#### Authentication with ALB + Cognito

ALB can be used to securely authenticate users for accessing your applications.\
This enables you to offload the work of authenticating users to your LB so that your applications can focus on their business logic.\
You can use Cognito User Pools to authenticate users through:
* IdP that is OpenID Connect (OIDC) compliant.
* well-known social IdPs, such as Amazon, Facebook, or Google through user pools supported by Cognito
* corporate identities, using SAML, LDAP, or Microsoft AD through user pools supported by Cognito

You configure user authentication by creating an authenticate action for one or more listener rules.

More: https://docs.aws.amazon.com/elasticloadbalancing/latest/application/listener-authenticate-users.html
